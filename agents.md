# AGENTS.md — Forest BD Viewer

> This file is the authoritative context document for AI coding agents working on this project.
> Read it in full before making any changes. Keep it up to date as the project evolves.

---

## Project Purpose

Full-stack geospatial application for visualizing French forest data (BD Forêt® V2) and Cadastre parcels for Île-de-France (departments 77, 78, 91, 95). Users authenticate, then explore an interactive map with drill-down, species inspection, and polygon analysis.

---

## Current Status

| Stage | Description | Status |
|---|---|---|
| 1 | Skeleton & Infrastructure | Complete |
| 2 | Authentication (register/login/me) | Complete |
| 3 | Forest Data Import & MVT Tiles | Complete |
| 4 | Drill-down, Cadastre, Map State | Complete (tile endpoints, admin GraphQL queries, map state persistence) |
| 5 | Polygon Analysis | Complete (analyzePolygon mutation, mapbox-gl-draw, AnalysisPanel) |
| 6 | Internationalization & Polish | Complete (EN/FR, ~70 keys, language toggle, dark/light theme, CSS design tokens, animations) |
| 7 | Bonus B — LiDAR CHM Analysis | Complete (analyzeLidar mutation, CHM overlay, pure Go GeoTIFF) |

See `tasks.md` for the full task checklist.

---

## Tech Stack

| Layer | Technology |
|---|---|
| Backend | Go 1.24+, Echo v4, gqlgen, pgx/v5, golang-migrate |
| Frontend | Next.js 16, React 19, TypeScript 5, Redux Toolkit, Mapbox GL JS 3.x, mapbox-gl-draw |
| Database | PostgreSQL 16 + PostGIS 3.4 |
| Cache | Redis 7 |
| Auth | JWT (HS256) via httpOnly cookie `auth_token` |
| i18n | React Context-based EN/FR dictionary (`src/lib/i18n.tsx`) |
| Theming | CSS custom properties + React Context (`src/lib/theme.tsx`), light/dark modes |
| Infrastructure | Docker Compose |

---

## Repository Layout

```
forest_bd_viewer/
├── backend/
│   ├── cmd/server/main.go          # Entry point: Echo setup, DB/Redis init, routes
│   ├── internal/
│   │   ├── auth/auth.go            # JWT generation/validation, bcrypt, Echo middleware
│   │   ├── cache/redis.go          # Redis client init
│   │   ├── config/config.go        # Viper config struct, helper methods
│   │   ├── database/database.go    # pgxpool init, migration runner
│   │   ├── geo/                    # Spatial queries (ST_AsMVT, polygon analysis, LiDAR)
│   │   │   ├── forest.go           # ForestTile — MVT for forest parcels
│   │   │   ├── admin.go            # AdminTile — MVT for admin boundaries
│   │   │   ├── cadastre.go         # CadastreTile — MVT for cadastre parcelles
│   │   │   ├── analysis.go         # AnalyzePolygon — spatial stats (area, TFV, species)
│   │   │   ├── lidar.go            # AnalyzeLidar — WFS tile query, CHM computation, PNG gen
│   │   │   └── geotiff.go          # Pure Go float32 GeoTIFF reader (no GDAL dependency)
│   │   ├── graph/                  # gqlgen resolvers/schema
│   │   │   ├── resolver.go         # Resolver struct (holds DB, AuthSvc, etc.)
│   │   │   ├── auth.resolvers.go   # Register, Login, Logout, Me + type wiring
│   │   │   ├── admin.resolvers.go  # Regions, Departements, Communes
│   │   │   ├── map.resolvers.go    # MyMapState, SaveMapState
│   │   │   ├── analysis.resolvers.go # AnalyzePolygon mutation
│   │   │   ├── lidar.resolvers.go  # AnalyzeLidar mutation
│   │   │   ├── generated/          # DO NOT EDIT — regenerated by gqlgen
│   │   │   ├── model/              # DO NOT EDIT — regenerated by gqlgen
│   │   │   └── schema/             # GraphQL schema source files
│   │   │       ├── auth.graphql    # Base Query/Mutation types + auth types
│   │   │       ├── admin.graphql   # extend Query: regions/departements/communes
│   │   │       ├── map.graphql     # extend Query: myMapState; extend Mutation: saveMapState
│   │   │       ├── analysis.graphql # extend Mutation: analyzePolygon
│   │   │       └── lidar.graphql   # extend Mutation: analyzeLidar
│   │   └── tiles/                  # MVT tile HTTP handlers — handler.go
│   ├── migrations/                 # golang-migrate SQL files: NNNNNN_name.{up,down}.sql
│   ├── Dockerfile                  # Multi-stage: golang:1.24-alpine → alpine:3.19
│   └── go.mod
├── frontend/
│   ├── src/
│   │   ├── app/
│   │   │   ├── layout.tsx          # Root layout, StoreProvider wrapper, anti-flash theme script
│   │   │   ├── page.tsx            # Home (dynamic import of Map, no SSR), top-right toolbar
│   │   │   ├── login/page.tsx      # Login form, dark mode + i18n
│   │   │   └── register/page.tsx   # Registration form, dark mode + i18n
│   │   ├── components/
│   │   │   ├── Map.tsx             # Mapbox GL map + MapboxDraw, client-side only
│   │   │   ├── Map.module.css
│   │   │   ├── AnalysisPanel.tsx   # Polygon analysis results (TFV + species breakdown)
│   │   │   └── AnalysisPanel.module.css
│   │   ├── lib/graphql.ts          # graphql-request client (sends credentials)
│   │   ├── lib/i18n.tsx            # EN/FR dictionary, I18nProvider, useI18n hook
│   │   ├── lib/theme.tsx           # ThemeProvider, useTheme hook, localStorage persistence
│   │   └── store/
│   │       ├── index.ts            # Redux store (auth + map + analysis reducers)
│   │       ├── authSlice.ts        # Auth state + fetchMe thunk
│   │       ├── mapSlice.ts         # Map center/zoom state + fetchMapState/saveMapStateThunk
│   │       ├── analysisSlice.ts    # Polygon analysis state + analyzePolygonThunk
│   │       └── StoreProvider.tsx   # Wraps Redux Provider + I18nProvider + ThemeProvider; dispatches fetchMe + fetchMapState
│   ├── Dockerfile                  # Multi-stage: node:20-alpine, output: standalone
│   └── next.config.ts              # output: 'standalone'
├── scripts/
│   ├── download-data.sh            # Fetch admin boundaries + cadastre from APIs; BD Forêt manual instructions
│   ├── import-data.sh              # Wrapper for import_data.py (runs inside Docker)
│   └── import_data.py              # PostGIS importer: ogr2ogr for SHP, psycopg2 for GeoJSON
├── docker-compose.yml
├── .env.example
├── tasks.md
└── agents.md                       # This file
```

---

## Environment Variables

Copy `.env.example` to `.env`. All values are consumed by Docker Compose and forwarded to services.

| Variable | Used by | Notes |
|---|---|---|
| `POSTGRES_USER` | backend, compose | DB user |
| `POSTGRES_PASSWORD` | backend, compose | DB password |
| `POSTGRES_DB` | backend, compose | Database name: `forest_bd` |
| `POSTGRES_HOST` | backend | `postgres` inside Docker, `localhost` locally |
| `POSTGRES_PORT` | backend | 5432 |
| `REDIS_HOST` | backend | `redis` inside Docker, `localhost` locally |
| `REDIS_PORT` | backend | 6379 |
| `BACKEND_PORT` | backend | 8080 |
| `JWT_SECRET` | backend | Must be set; min 32 chars recommended |
| `JWT_EXPIRY_HOURS` | backend | Default: 24 |
| `NEXT_PUBLIC_MAPBOX_TOKEN` | frontend | Required for map to render |
| `NEXT_PUBLIC_API_URL` | frontend | `http://localhost:8080` |

---

## Running the Project

```bash
# Full stack (recommended)
docker-compose up --build

# Frontend: http://localhost:3000
# Backend:  http://localhost:8080/health
```

Migrations run automatically on backend startup via `database.go`.

---

## Backend Conventions

### Package structure

- Each `internal/` package owns its own initialization and exported interface.
- Configuration is passed via `*config.Config`, not global variables.
- Database access uses `*pgxpool.Pool` passed as a dependency.

### Adding a new route

1. Define the handler function (or method on a struct) in the appropriate `internal/` package.
2. Register it in `cmd/server/main.go` on the Echo instance.
3. Apply `auth.Middleware` to protect routes that require authentication.

### Adding a migration

Name files strictly: `NNNNNN_description.up.sql` / `NNNNNN_description.down.sql`.
Current migrations run through `000005`. The next number is `000006`.
Migrations run automatically at startup; always provide a corresponding `.down.sql`.

### GraphQL (gqlgen)

- Schema files go in `internal/graph/schema/`. Each domain has its own `.graphql` file (`auth.graphql`, `admin.graphql`, `map.graphql`).
- Run `go generate ./internal/graph/...` from `backend/` after editing `.graphql` schema files to regenerate resolver stubs. Requires `go get github.com/99designs/gqlgen@v0.17.86` if `go.sum` is stale.
- gqlgen uses `layout: follow-schema` — each schema file generates a corresponding `{name}.resolvers.go`. The old monolithic `schema.resolvers.go` is gitignored and must not be recreated.
- Resolver type wiring (`Mutation()`, `Query()`, `mutationResolver`, `queryResolver`) lives in `auth.resolvers.go`.

### Authentication flow

- `auth.Middleware` (Echo middleware) extracts JWT from `auth_token` cookie, falls back to `Authorization: Bearer` header.
- Invalid/missing token = guest (does **not** abort the request).
- Downstream handlers check for an authenticated user via `auth.GetUser(ctx)`.
- For protected resolvers/handlers, explicitly return `401` if `auth.GetUser(ctx)` is nil.

### Error handling

- Return structured JSON errors from Echo handlers: `c.JSON(http.StatusXXX, echo.Map{"error": "..."})`.
- GraphQL errors use gqlgen's standard error interface.

---

## Frontend Conventions

### Mapbox components

- The `Map` component must be dynamically imported with `{ ssr: false }` — Mapbox GL JS requires the browser DOM.
- Map initialization fires inside a `useEffect` with an empty dependency array.
- Attach layers/sources after the `map.on('load', ...)` event.

### State management

- Use Redux Toolkit slices in `src/store/`. One slice per domain (e.g., `authSlice`, `mapSlice`, `analysisSlice`).
- Keep server state (GraphQL responses) separate from UI state (Redux).

### GraphQL client

- The client is initialized in `src/lib/graphql.ts` and sends `credentials: 'include'` for cookie-based auth.
- Import and use this shared instance; do not instantiate new clients inline.

### Path aliases

- Use `@/` for imports from `src/`. Configured in `tsconfig.json`.

### Routing

- Use Next.js App Router (`src/app/`). New pages go in `src/app/<route>/page.tsx`.
- Auth-protected pages should redirect to `/login` if no session exists.

---

## Database Schema Reference

### `users` (migration 000001, updated by 000005)

| Column | Type | Notes |
|---|---|---|
| `id` | UUID (PK) | `uuid_generate_v4()` default |
| `email` | TEXT UNIQUE NOT NULL | Indexed |
| `password_hash` | TEXT NOT NULL | bcrypt |
| `name` | TEXT NOT NULL | |
| `created_at` | TIMESTAMPTZ | `NOW()` default |
| `updated_at` | TIMESTAMPTZ | `NOW()` default |
| `preferences` | JSONB NOT NULL | Default `'{}'`; stores per-user settings e.g. `{"map": {"lng":2.35,"lat":48.86,"zoom":6}}` |

### `forest_parcels` (migration 000002)

| Column | Type | Notes |
|---|---|---|
| `id` | SERIAL (PK) | Auto-increment |
| `code_tfv` | VARCHAR(10) | BD Forêt TFV code (e.g. FF1, FO2, LA) |
| `lib_tfv` | VARCHAR(255) | TFV label |
| `essence1` | VARCHAR(10) | Dominant species code |
| `essence2` | VARCHAR(10) | Secondary species code |
| `departement` | VARCHAR(3) | Department number (77, 78, 91, 95) |
| `geom` | GEOMETRY(MULTIPOLYGON, 4326) | GIST-indexed |

### `regions` (migration 000003)

| Column | Type | Notes |
|---|---|---|
| `id` | SERIAL (PK) | Auto-increment |
| `code` | VARCHAR(3) UNIQUE | INSEE region code (e.g. "11" for Île-de-France) |
| `nom` | TEXT | Region name |
| `geom` | GEOMETRY(MULTIPOLYGON, 4326) | GIST-indexed |

### `departements` (migration 000003)

| Column | Type | Notes |
|---|---|---|
| `id` | SERIAL (PK) | Auto-increment |
| `code` | VARCHAR(3) UNIQUE | INSEE dept code (77, 78, 91, 95…) |
| `nom` | TEXT | Department name |
| `region_code` | VARCHAR(3) | FK → regions.code |
| `geom` | GEOMETRY(MULTIPOLYGON, 4326) | GIST-indexed |

### `communes` (migration 000003)

| Column | Type | Notes |
|---|---|---|
| `id` | SERIAL (PK) | Auto-increment |
| `code` | VARCHAR(5) UNIQUE | 5-digit INSEE commune code |
| `nom` | TEXT | Commune name |
| `departement_code` | VARCHAR(3) | FK → departements.code |
| `region_code` | VARCHAR(3) | FK → regions.code |
| `geom` | GEOMETRY(MULTIPOLYGON, 4326) | GIST-indexed |

### `cadastre_parcelles` (migration 000004)

| Column | Type | Notes |
|---|---|---|
| `id` | SERIAL (PK) | Auto-increment |
| `commune` | VARCHAR(5) | 5-digit commune code |
| `departement` | VARCHAR(3) | Department number |
| `section` | VARCHAR(10) | Cadastral section |
| `numero` | VARCHAR(10) | Parcel number |
| `geom` | GEOMETRY(MULTIPOLYGON, 4326) | GIST-indexed |

---

## Key Interfaces & APIs

### Backend HTTP

| Method | Path | Auth | Description |
|---|---|---|---|
| GET | `/health` | Public | Returns JSON with DB and Redis status |
| POST | `/graphql` | Mixed | GraphQL endpoint (gqlgen) |
| GET | `/tiles/foret/:z/:x/:y.mvt` | Required | MVT forest tiles — cached in Redis 24h |
| GET | `/tiles/admin/:layer/:z/:x/:y.mvt` | Public | MVT admin boundary tiles — layer: regions/departements/communes — cached 7 days |
| GET | `/tiles/cadastre/:z/:x/:y.mvt` | Required | MVT cadastre parcel tiles — cached 24h |
| GET | `/lidar/chm/:id` | Public | Serves generated CHM PNG images |

### GraphQL (actual schema)

```graphql
type Query {
  me: User
  regions: [Region!]!
  departements(regionCode: String): [Departement!]!
  communes(departementCode: String): [Commune!]!
  myMapState: MapState        # null for guests; returns saved center/zoom for auth users
}

type Mutation {
  register(email: String!, password: String!, name: String!): AuthPayload!
  login(email: String!, password: String!): AuthPayload!
  logout: Boolean!
  saveMapState(lng: Float!, lat: Float!, zoom: Float!): Boolean!
  analyzePolygon(geojson: String!): PolygonAnalysis!   # auth required
  analyzeLidar(geojson: String!): LidarAnalysis!       # auth required
}

type AuthPayload { user: User! }
type User { id: ID!, email: String!, name: String!, createdAt: String! }
type Region { id: ID!, code: String!, nom: String! }
type Departement { id: ID!, code: String!, nom: String!, regionCode: String }
type Commune { id: ID!, code: String!, nom: String!, departementCode: String }
type MapState { lng: Float!, lat: Float!, zoom: Float! }
type PolygonAnalysis {
  areaHa: Float!, forestCoverHa: Float!, forestCoverPct: Float!, parcelCount: Int!
  tfvBreakdown: [TfvBreakdown!]!, speciesBreakdown: [SpeciesBreakdown!]!
}
type TfvBreakdown { codeTfv: String!, libTfv: String!, areaHa: Float!, pct: Float! }
type SpeciesBreakdown { essence: String!, areaHa: Float!, pct: Float! }
type LidarAnalysis {
  hasCoverage: Boolean!, message: String
  minHeight: Float, maxHeight: Float, meanHeight: Float, medianHeight: Float
  chmImageUrl: String, bounds: [Float!]
}
```

---

## Important Notes for Agents

- **Do not modify `docker-compose.yml`** unless changing service topology — environment variable names are referenced by multiple services.
- **Do not regenerate** the entire `go.sum` or run `go mod tidy` unless you have added/removed a dependency. The existing lockfile is correct.
- **PostGIS spatial data** uses SRID 2154 (RGF93 Lambert 93) in source shapefiles. Convert to EPSG:4326 on import, or handle the projection in ST_AsMVT queries.
- **Mapbox tokens** are public-facing (prefixed `NEXT_PUBLIC_`). Never expose `JWT_SECRET` or DB credentials to the frontend.
- **Migrations are irreversible in production** — always write a correct `.down.sql` before committing a `.up.sql`.
- **Redis** is used for MVT tile caching and session data. Default TTL for tiles: use 24h unless data is dynamic.
- **gqlgen** requires code generation after schema changes. Note that in `go.mod` gqlgen is listed under `require` — run `go generate ./internal/graph/...` to regenerate.
- The frontend `Dockerfile` uses `output: 'standalone'` — the production entrypoint is `node server.js`, not `npm start`.

---

## Internationalization (i18n)

The app uses a React Context-based dictionary pattern in `frontend/src/lib/i18n.tsx`.

- **Default locale**: `en` (English). Toggle switches to `fr` (French).
- **~70 translation keys** covering: analysis panel, draw buttons, legend labels, popup content, TFV classification names, LiDAR stats, auth pages, theme toggles.
- **Usage**: `const { t, locale, toggle } = useI18n()` — call `t('key.name')` for translated strings.
- **Type-safe**: `DictKey` type ensures only valid keys are used at compile time.
- **Language toggle button**: Rendered in the top-right toolbar on the main page (alongside user name, theme toggle, and sign out). On login/register pages, a circular `FR`/`EN` button is positioned at top-right.

### Map component i18n

Map event handlers run inside a `useEffect` that only fires once. To access the latest locale in these handlers, a `tRef` (React ref) is kept in sync: `tRef.current = t`. Popup HTML uses `tRef.current('popup.tfvCode')` etc.

### Adding a new translation key

1. Add the key to `dict` in `frontend/src/lib/i18n.tsx` with both `en` and `fr` values.
2. Use `t('your.key')` in JSX or `tRef.current('your.key')` in map event handlers.

---

## Theming & Dark Mode

The app supports light and dark themes via CSS custom properties and a React Context provider.

### Architecture

- **CSS variables**: `globals.css` defines 30+ semantic tokens in `:root` (light) and `[data-theme="dark"]` (dark). All colors, shadows, and borders are expressed as variables.
- **ThemeProvider**: `frontend/src/lib/theme.tsx` provides `useTheme()` hook returning `{ theme, toggle }`. State is persisted to `localStorage('forest-bd-theme')`.
- **DOM attribute**: Theme is applied by setting `data-theme="dark"` on `<html>`. CSS variable overrides cascade automatically.
- **Anti-flash script**: An inline `<script>` in `layout.tsx` reads localStorage before React hydrates, preventing a flash of light theme on dark-mode reloads. `suppressHydrationWarning` is set on `<html>`.

### Dark palette (forest-at-dusk)

| Token | Light | Dark |
|-------|-------|------|
| `--color-bg` | `#fafafa` | `#0f1a14` |
| `--color-surface` | `#ffffff` | `#1a2b22` |
| `--color-primary` | `#2d6a4f` | `#52b788` |
| `--color-text` | `#1a1a1a` | `#e1e8e3` |
| `--color-border` | `#e5e7eb` | `#2d3f34` |
| `--color-error` | `#c0392b` | `#f87171` |

### Theme toggle locations

- **Main page**: Top-right toolbar — moon/sun icon button between the language toggle and sign-out.
- **Login/Register pages**: Fixed-position circular buttons at top-right (theme + language toggle pair).

### Animations & transitions

- **Theme switch**: 0.3s ease transition on `background-color`, `color`, `border-color`, `box-shadow` for all elements. Mapbox canvas is excluded (`transition: none !important`).
- **Analysis panel**: Slides in from left (0.3s ease-out `translateX`), metrics fade up (0.4s).
- **Bar fills**: Cover bar and breakdown bars use `cubic-bezier(0.4, 0, 0.2, 1)` deceleration easing.
- **Draw buttons**: Hover lift (`translateY(-1px)` + shadow gain), active press-down.
- **Mapbox popups**: Styled via global CSS overrides to respect theme variables.

### Adding dark mode support to new components

1. Use CSS variables (`var(--color-text)`, `var(--color-surface)`, etc.) instead of hardcoded hex values.
2. For inline styles in React components, CSS variables work: `style={{ color: 'var(--color-text)' }}`.
3. For CSS modules, reference the same variables. No additional `[data-theme="dark"]` selectors are needed — the variable values change automatically.

---

## TFV Code Normalization

BD Forêt V2 stores hierarchical vegetation codes in `forest_parcels.code_tfv`:

- **New BD Forêt V2** (dept 95): `FF1-00-00`, `FF1-09-09`, `FF1G01-01`, `FF2G61-61`, `LA4`, `FF31`, `FF32`, `FO1`, `FP`
- **Legacy TFIFN** (depts 78, 91): `AFJ`, `AFV`, `CPJ`, `CPV`, `CRJ`, `CRV`, `FR`, `MR`, `HFW`, `HFZ`, `QF`, `30`, `40`, `50`

The `analyzePolygon` backend query (`geo/analysis.go`) normalizes all codes to 9 canonical top-level categories using a SQL `CASE` expression:

| Normalized | BD Forêt V2 sources | Legacy TFIFN sources |
|---|---|---|
| `FF1` | `FF1%`, `FF0` | `AFJ`, `AFV`, `HFW`, `HFZ`, `QF` |
| `FF2` | `FF2%` | `CPJ`, `CPV`, `CRJ`, `CRV` |
| `FF3` | `FF3%` | `FR`, `MR` |
| `FF4` | (catch-all) | — |
| `FO1` | `FO1%` | `30` |
| `FO2` | `FO2%` | — |
| `FO3` | `FO3%` | — |
| `LA` | `LA%` | `40` |
| `FP` | `FP` | `50` |

This ensures the frontend i18n keys (`tfv.FF1`, `tfv.FF2`, etc.) always match, and the TFV breakdown provides a high-level forest structure overview complementary to the species breakdown.

---

## Polygon Drawing UX

The polygon drawing tool uses `@mapbox/mapbox-gl-draw` with custom UI:

- **No built-in toolbar** — custom buttons provided in `Map.tsx`.
- **Drawing mode**: "Analyse area" button enters `draw_polygon` mode. Two buttons appear: green "Finish" and red "Cancel".
- **Completing a polygon**: Clicking "Finish" calls `draw.changeMode('simple_select')`, which completes the polygon and triggers the `draw.create` event. Double-click also works as a standard fallback.
- **Immovable polygon**: After `draw.create`, the drawn feature is removed from MapboxDraw and re-added as a static GeoJSON source/layer (`analysis-polygon-fill`, `analysis-polygon-outline`). This prevents accidental dragging.
- **Click suppression**: All map feature click handlers (regions, departments, communes, foret, cadastre) check `analysisStatusRef.current === 'drawing'` and return early to prevent popup interference during drawing.

---

## LiDAR CHM Analysis (Bonus B)

### Overview

The application can compute a Canopy Height Model (CHM = MNS - MNT) from IGN's LIDAR HD data for any drawn polygon. This is implemented entirely in Go (no Python/GDAL dependency).

### Data Source

- **IGN LIDAR HD**: Progressive nationwide LiDAR coverage of France
- **WFS tile index**: `https://data.geopf.fr/wfs/ows` provides `IGNF_MNS-LIDAR-HD:dalle` and `IGNF_MNT-LIDAR-HD:dalle` feature types
- **Tiles**: 1km x 1km GeoTIFF at 0.5m resolution (2000x2000 pixels), typically EPSG:2154 (Lambert 93)
- **Coverage**: ~486k tiles total but **zero coverage for Ile-de-France** as of 2025. The feature works for areas with LiDAR HD data and gracefully shows "No LiDAR HD coverage" otherwise.

### Processing Pipeline

1. **WFS query**: Query tile index to find MNS and MNT tiles intersecting the polygon bbox
2. **Tile matching**: Pair MNS/MNT tiles by grid coordinates extracted from tile names (e.g., `0599_6329`)
3. **Download**: Download GeoTIFF tiles via WMS GetMap with disk cache at `/tmp/lidar-cache/`
4. **GeoTIFF parsing**: Pure Go TIFF reader (`geotiff.go`) handles float32 samples, DEFLATE compression, strip/tile organization
5. **CHM computation**: Per-pixel `MNS - MNT`, clamping negatives to 0
6. **Stats**: min/max/mean/median canopy height
7. **PNG generation**: Color ramp (green -> yellow -> red) at source resolution
8. **CRS conversion**: Approximate Lambert 93 -> WGS84 for Mapbox overlay bounds

### Key Constants

- `maxLidarTiles = 25` — limits processing to avoid excessive download
- `tileCacheDir = "/tmp/lidar-cache"` — disk cache for downloaded tiles
- `wfsBaseURL = "https://data.geopf.fr/wfs/ows"` — IGN WFS endpoint

### Frontend Integration

- `analyzeLidarThunk` is dispatched alongside `analyzePolygonThunk` when a polygon is drawn
- AnalysisPanel shows LiDAR stats (min/max/mean/median height) when coverage exists
- CHM PNG is overlaid on the map as a Mapbox `ImageSource` with 60% opacity
- Overlay is cleaned up when the analysis is cleared
